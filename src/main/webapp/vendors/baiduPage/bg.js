function enablePriceCompare(){localStorage.pcnotification="true",localStorage.popupnotification="true",localStorage.barnotification="true",localStorage.show_feature_bar="false",refreshOptions()}function disablePriceCompare(){localStorage.pcnotification="false",localStorage.popupnotification="false",localStorage.barnotification="false","never"!==localStorage.show_feature_bar&&(localStorage.show_feature_bar="true"),refreshOptions()}function captureVisible(){function e(){chrome.windows.update(currentWindowId,{focused:!0},function(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){dataURL.push(e),newTab()})})})}type="visible",getSelectedTab(e)}function captureSelected(){type="selected",getSelectedTab(checkContentScript)}function captureEntire(){type="entire",getSelectedTab(checkContentScript)}function getSelectedTab(e){chrome.tabs.getSelected(null,function(t){tabid=t.id,taburl=t.url,tabtitle=t.title,null!=e&&e()})}function checkContentScript(){chrome.tabs.executeScript(tabid,{file:"javascripts/isload.js"})}function saveAndScroll(){pushDataURL()}function pushDataURL(){chrome.windows.update(currentWindowId,{focused:!0},function(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){dataURL.push(e),sendRequest("tab",tabid,{action:"scroll_next"})})})})}function updateShortcutsRequest(e){sendRequest("tab",e,{action:"update_shortcuts",msObj:localStorage.msObj})}function newTab(){console.log(dataURL instanceof String,dataURL,menuType),dataURL?("selected"==menuType&&sendRequest("tab",tabid,{action:"destroy_selected"}),"true"==localStorage.autoSave?prepareImage():chrome.tabs.create({url:"edit.html"},function(e){console.log(tabid+"+"+e.id),tabids[e.id]=tabid,tabid=e.id})):alert("Screen Capture Fail!!")}function prepareImage(){var e,t,a=document.getElementById("tempCanvas"),o=a.getContext("2d"),r=document.getElementById("test_image"),c=(document.getElementById("temp_image"),17),i=function(){function s(e,a,r,c,i,l,d,p,b){d=h*t,h==w-1&&(r=t-lastH,i=b=lastH),console.log(h,n,w-1),$("#temp_image").attr({src:e}).load(function(){$(this).unbind("load"),o.drawImage(this,a,r,c,i,l,d,p,b),++h>w-1?(console.log("nextCol"),u()):(console.log("PrepareV"),s(g[++n],a,r,c,i,l,d,p,b))})}function l(t,a,n,r,c,i,s,d,u){i=j*e,j==v-1&&(a=e-lastW,r=d=lastW),$("#temp_image").attr({src:t}).load(function(){$(this).unbind("load"),o.drawImage(this,a,n,r,c,i,s,d,u),v-1>j&&l(g[++j],a,n,r,c,i,s,d,u)})}function d(){$(a).attr({width:p,height:b})}function u(){if(++j>v-1){var o=document.getElementById("pluginobj");return"jpg"==localStorage.format?tempDataUrl=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=a.toDataURL()),console.log("final",tempDataUrl),o.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),void setTimeout(function(){chrome.tabs.getSelected(function(e){chrome.tabs.sendRequest(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),chrome.extension.sendRequest({action:"closeWin"})},1e3)}j==v-1?(S=e-lastW,y=dw=p-j*e,R=j*e):(S=0,y=dw=e,R=j*e),_=0,k=dh=t,T=0,h=0,n=h+j*w,s(g[n],S,_,y,k,R,T,dw,dh)}if(e=r.width,t=r.height,console.log(menuType),"visible"==type){var p,b;console.log(centerW,centerH,r.width,r.height),"selected"==menuType?(p=centerW*window.devicePixelRatio,b=centerH*window.devicePixelRatio,S=centerOffX,_=centerOffY):(p=r.width,b=r.height,S=0,_=0),$("#tempCanvas").attr({width:p,height:b}),o.drawImage(r,S*window.devicePixelRatio,_*window.devicePixelRatio,p,b,0,0,p,b),"jpg"==localStorage.format?tempDataUrl=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=a.toDataURL());var m=document.getElementById("pluginobj");console.log(tempDataUrl,tabtitle),m.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout(function(){chrome.tabs.getSelected(function(e){chrome.tabs.sendRequest(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),chrome.extension.sendRequest({action:"closeWin"})},1e3)}else if("entire"==type||"selected"==type){var g=dataURL;console.log("enter entire",g.length,counter,t,e);var h=j=n=0,f=g.length,v=counter,w=Math.round(f/v);if(!scrollBar.x&&scrollBar.y){e-=c,w=f,lastH=t*ratio.y,"selected"==menuType?(scrollBar.realX&&(t-=c),p=centerW*window.devicePixelRatio):p=e,b=lastH?t*(w-1)+lastH:t*w,d();var S=0,y=dw=e,R=0,_=0,k=dh=t,T=0;s(g[n],S,_,y,k,R,T,dw,dh)}if(scrollBar.x&&!scrollBar.y){t-=c,v=f,lastW=e*ratio.x,"selected"==menuType?(scrollBar.realY&&(e-=c),b=centerH*window.devicePixelRatio):b=t,p=lastW?e*(v-1)+lastW:e*v,d();var S=0,y=dw=e,R=0,_=0,k=dh=t,T=0;l(g[n],S,_,y,k,R,T,dw,dh)}if(scrollBar.x&&scrollBar.y){lastW=e*ratio.x,lastH=t*ratio.y,e-=c,t-=c,"selected"==menuType?(p=centerW*window.devicePixelRatio,b=centerH*window.devicePixelRatio):(p=lastW?e*(v-1)+lastW:e*v,b=lastH?t*(w-1)+lastH:t*w),d();var S=0,y=dw=e,R=0,_=0,k=dh=t,T=0;s(g[n],S,_,y,k,R,T,dw,dh)}}dataURL=[],r.removeEventListener("onload",i,!1),r.src=""};r.onload=i,r.src=dataURL[0]}function sendRequest(e,t,a){switch(e){case"tab":console.log(t),console.log(a),chrome.tabs.sendRequest(t,a);break;case"popup":chrome.extension.sendRequest(a)}}function onLicenseUpdate(e){function t(){if(o>0){for(var e=0;o>e;e++)if("capture_desktop_window"===a[e].sku)return!0;return!1}return!1}var a=e.response.details;console.log("onLicenseUpdate",a);var o=a.length;console.log(t()),localStorage.capture_desktop=t()?"true":"false"}function onLicenseUpdateFail(e){console.log("onSkuDetailsFailed",e)}function beginDesktop(){chrome.desktopCapture.chooseDesktopMedia(["screen","window"],function(e){function t(e){console.log(e);var t=document.createElement("video");t.addEventListener("canplay",function(){var a=document.createElement("canvas"),o=a.getContext("2d");a.width=t.videoWidth,a.height=t.videoHeight,o.drawImage(t,0,0,a.width,a.height),dataURL=[],dataURL.push(a.toDataURL()),console.log(dataURL),t.pause(),t.src="",e.stop(),$(t).remove(),$(a).remove(),tabtitle="Desctop screenshot",type="visible",menuType="desktop",newTab()},!1),t.src=window.URL.createObjectURL(e)}function a(e){console.log(e),alert(e)}if(e){console.log(e);var o={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(o,t,a)}})}var win,currentTabId,autoSave=!1,menuType,type,dataURL=[],tabid,taburl,tabtitle,counter,ratio,scrollBar,centerW=0,centerH=0,currentversion=chrome.app.getDetails().version,tabids={},data,tempDataUrl,currentWindowId,currentTabId,D_T,centerOffX=0,centerOffY=0;localStorage.msObj||(localStorage.msObj='{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"S"},"entire":{"enable":true,"key":"E"}}'),localStorage.format||(localStorage.format="png"),localStorage.delay_sec||(localStorage.delay_sec=3),localStorage["data-tracking"]||(localStorage["data-tracking"]=!0),D_T="true"==localStorage["data-tracking"],$(document).ready(function(){}),localStorage.autoSave="false",chrome.extension.onRequest.addListener(function(e,t,a){function o(){console.log(77,menuType,tabid,taburl),sendRequest("tab",tabid,{menuType:menuType,type:type,data:dataURL,taburl:taburl,tabtitle:tabtitle,counter:counter,ratio:ratio,scrollBar:scrollBar,centerW:centerW,centerH:centerH,w:n.width,h:n.height,centerOffX:centerOffX,centerOffY:centerOffY,autoSave:autoSave}),autoSave=!1,dataURL=[],n.src="",n.removeEventListener("onload",o,!1),n=null}switch(console.log(t.tab),chrome.tabs.getSelected(null,function(e){currentWindowId=e.windowId,currentTabId=e.id}),console.log(e.action,menuType,t),t.tab&&-1!=t.tab.id&&"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action||(menuType=e.action,e.menuType&&(menuType=e.menuType)),e.action){case"visible":"selected"==menuType&&(type="visible",centerW=e.centerW,centerH=e.centerH),captureVisible(),sendRequest("tab",tabid,{action:"restorebar"});break;case"selected":captureSelected();break;case"entire":captureEntire();break;case"https":alert("For security reason, Capture Selected Area doesn't work in https pages! Please try other options.");case"insert_script":"selected"==menuType&&(chrome.tabs.executeScript(tabid,{file:"javascripts/dragresize.js"}),chrome.tabs.insertCSS(tabid,{file:"stylesheets/selected.css"}),console.log("insert")),chrome.tabs.executeScript(tabid,{file:"javascripts/content_script.js"},function(){sendRequest("tab",tabid,{action:"init_"+menuType+"_capture"})});break;case"script_running":sendRequest("tab",tabid,{action:"init_"+type+"_capture"});break;case"check_shortcuts":console.log("check_shortcuts"),updateShortcutsRequest(t.tab.id);break;case"update_shortcuts":console.log("update_shortcuts"),chrome.tabs.getAllInWindow(null,function(e){for(var t=0,a=e.length;a>t;t++){var o=e[t],n=o.url;n.match(/https?:\/\/*\/*/gi)&&!n.match(/https:\/\/chrome.google.com\/extensions/i)&&updateShortcutsRequest(o.id)}});break;case"scroll_next_done":sendRequest("tab",tabid,{action:"hidescroll"}),saveAndScroll(),sendRequest("tab",tabid,{action:"restorescroll"});break;case"entire_capture_done":counter=e.counter,ratio=e.ratio,scrollBar=e.scrollBar,type="entire","selected"==menuType&&(centerW=e.centerW,centerH=e.centerH),sendRequest("tab",tabid,{action:"restorebar"}),newTab();break;case"capture_selected_done":type="visible",centerH=e.data.h,centerW=e.data.w,centerOffX=e.data.x,centerOffY=e.data.y,captureVisible();break;case"capture_selected_discriminate_done":autoSave=!0,type="visible",centerH=e.data.h,centerW=e.data.w,centerOffX=e.data.x,centerOffY=e.data.y,captureVisible();break;case"ready":var n=document.getElementById("test_image");n.onload=o,console.log(dataURL[0]),n.src=dataURL[0];break;case"copy":chrome.experimental.clipboard.executeCopy(tabid,function(){alert("copied")});break;case"exit":chrome.tabs.getSelected(null,function(e){chrome.tabs.remove(e.id)});break;case"get_option":a({options:localStorage.msObj});break;case"newtip":if(!localStorage.version||localStorage.version!=currentversion){var r={text:""};chrome.browserAction.setBadgeText(r),count=1,window.open("https://www.diigo.com/awe/new-for-awesome-screenshot.html?v="+currentversion),localStorage.version=currentversion,chrome.extension.sendRequest({action:"shownew"})}break;case"openNewTab":var c=e.url;chrome.tabs.create({url:c});break;case"enablePriceCompare":console.log("enable"),enablePriceCompare(),localStorage.show_feature_bar="false";break;case"getShowFeatureBar":a(localStorage.show_feature_bar);break;case"disableShowFeatureBar":localStorage.show_feature_bar="never";break;case"getAD":$.get("http://api.hostip.info/get_json.php",function(t){var o=t.ip,n=encodeURIComponent(e.url),r=e.query.replace(/\s/g,"+"),c=encodeURI(window.navigator.userAgent),i="http://65975.xml.premiumxml.com/xml/?fid=65975&keywords="+r+"&user_ip="+o+"&ua="+c+"&serve_url="+n;$.get(i,function(e){var t=e,o=t.getElementsByTagName("listing"),n=o.length;if(n){for(var r=[],c=0;n>c;c++){var i=JSON.parse(xml2json(o[c],""));r.push(i.listing)}a({data:r})}})});break;case"desktop":}}),chrome.tabs.onRemoved.addListener(function(e){tabids[e]&&chrome.tabs.update(tabids[e],{selected:!0})}),chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason&&chrome.tabs.create({url:"http://biji.baidu.com"})}),localStorage.removeItem("isClickedOnNew"),localStorage.version=currentversion;